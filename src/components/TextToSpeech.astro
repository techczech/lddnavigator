---
// Text-to-Speech component using Web Speech API
---

<!-- TTS Control Panel - Fixed position -->
<div id="tts-panel" style="display:none; position:fixed; bottom:1rem; right:1rem; z-index:50;">
  <div style="background:#fff; border-radius:0.5rem; box-shadow:0 4px 12px rgba(0,0,0,0.15); border:1px solid #e5e7eb; padding:0.75rem;">
    <div style="display:flex; align-items:center; gap:0.5rem;">
      <button id="tts-play-btn" title="Play whole page" style="display:flex; align-items:center; justify-content:center; width:2.5rem; height:2.5rem; border-radius:0.5rem; border:none; cursor:pointer; background:#6b8c3a; color:white;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
      </button>
      <button id="tts-pause-btn" title="Pause" style="display:none; align-items:center; justify-content:center; width:2.5rem; height:2.5rem; border-radius:0.5rem; border:none; cursor:pointer; background:#e88a1e; color:white;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 007.25 3h-1.5zM12.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5z"/></svg>
      </button>
      <button id="tts-stop-btn" title="Stop" style="display:flex; align-items:center; justify-content:center; width:2.5rem; height:2.5rem; border-radius:0.5rem; border:none; cursor:pointer; background:#6b7280; color:white;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M4.75 3A1.75 1.75 0 003 4.75v10.5c0 .966.784 1.75 1.75 1.75h10.5A1.75 1.75 0 0017 15.25V4.75A1.75 1.75 0 0015.25 3H4.75z"/></svg>
      </button>
      <button id="tts-close-btn" title="Close" style="display:flex; align-items:center; justify-content:center; width:2.5rem; height:2.5rem; border-radius:0.5rem; border:none; cursor:pointer; background:#d1d5db; color:#374151;">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div id="tts-status" style="font-size:0.75rem; color:#6b7280; margin-top:0.5rem; text-align:center; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></div>
  </div>
</div>

<!-- TTS Toggle Button -->
<button
  id="tts-toggle-btn"
  title="Read aloud - click to activate"
  style="position:fixed; bottom:1rem; right:1rem; z-index:40; background:#4faad8; color:white; padding:0.75rem; border-radius:9999px; box-shadow:0 4px 12px rgba(0,0,0,0.2); border:none; cursor:pointer;"
>
  <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
  </svg>
</button>

<style is:global>
  /* Highlight speakable sections on hover when TTS is active */
  .tts-active .tts-hoverable {
    transition: background-color 0.15s ease, outline-color 0.15s ease;
    cursor: pointer;
  }

  .tts-active .tts-hoverable:hover {
    background-color: rgba(79, 170, 216, 0.12) !important;
    outline: 3px dashed #4faad8 !important;
    outline-offset: 4px;
    border-radius: 4px;
  }

  /* Currently speaking indicator */
  .tts-speaking {
    outline: 4px solid #6b8c3a !important;
    outline-offset: 4px;
    background-color: rgba(107, 140, 58, 0.15) !important;
    border-radius: 4px;
    animation: tts-pulse 1.5s ease-in-out infinite;
  }

  @keyframes tts-pulse {
    0%, 100% {
      outline-color: #6b8c3a;
    }
    50% {
      outline-color: #5a7830;
    }
  }
</style>

<script is:inline>
(function() {
  if (!('speechSynthesis' in window)) {
    var btn = document.getElementById('tts-toggle-btn');
    if (btn) btn.style.display = 'none';
    return;
  }

  var synth = window.speechSynthesis;
  var toggleBtn = document.getElementById('tts-toggle-btn');
  var panel = document.getElementById('tts-panel');
  var playBtn = document.getElementById('tts-play-btn');
  var pauseBtn = document.getElementById('tts-pause-btn');
  var stopBtn = document.getElementById('tts-stop-btn');
  var closeBtn = document.getElementById('tts-close-btn');
  var statusEl = document.getElementById('tts-status');

  var currentElement = null;
  var isActive = false;
  var textQueue = [];
  var queueIndex = 0;

  function markSpeakableSections() {
    var selectors = 'main section, main article, main p, main li, main h1, main h2, main h3, main h4, main div.prose, main div[class*="bg-"]';
    var els = document.querySelectorAll(selectors);
    for (var i = 0; i < els.length; i++) {
      var el = els[i];
      // Skip TTS UI, nav, header, footer
      if (el.closest('#tts-panel') || el.closest('#tts-toggle-btn') || el.closest('nav') || el.closest('header') || el.closest('footer')) continue;
      // Only mark if it has meaningful text
      var text = (el.textContent || '').trim();
      if (text.length > 10) {
        el.setAttribute('data-tts-block', 'true');
        el.classList.add('tts-hoverable');
      }
    }
  }

  function getTextContent(el) {
    var clone = el.cloneNode(true);
    var remove = clone.querySelectorAll('script, style');
    for (var i = 0; i < remove.length; i++) remove[i].remove();
    return (clone.textContent || '').replace(/\s+/g, ' ').trim();
  }

  function showPlaying() {
    playBtn.style.display = 'none';
    pauseBtn.style.display = 'flex';
  }

  function showPaused() {
    playBtn.style.display = 'flex';
    pauseBtn.style.display = 'none';
  }

  function clearSpeaking() {
    if (currentElement) {
      currentElement.classList.remove('tts-speaking');
      currentElement = null;
    }
  }

  function speak(text, element) {
    if (!text) return;
    synth.cancel();
    clearSpeaking();

    var utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 0.9;
    utterance.pitch = 1;

    showPlaying();

    if (element) {
      currentElement = element;
      element.classList.add('tts-speaking');
    }

    utterance.onend = function() {
      clearSpeaking();
      if (queueIndex < textQueue.length - 1) {
        queueIndex++;
        speak(textQueue[queueIndex]);
      } else {
        showPaused();
        statusEl.textContent = 'Finished';
        textQueue = [];
        queueIndex = 0;
      }
    };

    utterance.onerror = function() {
      clearSpeaking();
      showPaused();
      statusEl.textContent = 'Error occurred';
    };

    synth.speak(utterance);
    var preview = text.length > 35 ? text.substring(0, 35) + '...' : text;
    statusEl.textContent = preview;
  }

  function speakElement(element) {
    var text = getTextContent(element);
    if (text) {
      textQueue = [text];
      queueIndex = 0;
      speak(text, element);
    }
  }

  function speakPage() {
    var main = document.querySelector('main');
    if (!main) return;
    var text = getTextContent(main);
    if (!text) return;

    var sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
    textQueue = [];
    var chunk = '';
    for (var i = 0; i < sentences.length; i++) {
      if (chunk.length + sentences[i].length < 200) {
        chunk += sentences[i];
      } else {
        if (chunk) textQueue.push(chunk.trim());
        chunk = sentences[i];
      }
    }
    if (chunk) textQueue.push(chunk.trim());

    queueIndex = 0;
    if (textQueue.length > 0) {
      speak(textQueue[0]);
      statusEl.textContent = 'Reading page (' + textQueue.length + ' parts)';
    }
  }

  function showPanel() {
    panel.style.display = 'block';
    toggleBtn.style.display = 'none';
    document.body.classList.add('tts-active');
    isActive = true;
    markSpeakableSections();
    statusEl.textContent = 'Click any highlighted section, or press Play';
  }

  function hidePanel() {
    synth.cancel();
    clearSpeaking();
    panel.style.display = 'none';
    toggleBtn.style.display = 'block';
    document.body.classList.remove('tts-active');
    isActive = false;
    // Remove hoverable classes
    var hoverables = document.querySelectorAll('.tts-hoverable');
    for (var i = 0; i < hoverables.length; i++) {
      hoverables[i].classList.remove('tts-hoverable');
    }
    showPaused();
    textQueue = [];
    queueIndex = 0;
  }

  // Button handlers
  toggleBtn.addEventListener('click', showPanel);
  closeBtn.addEventListener('click', hidePanel);

  playBtn.addEventListener('click', function() {
    if (synth.paused) {
      synth.resume();
      showPlaying();
    } else {
      speakPage();
    }
  });

  pauseBtn.addEventListener('click', function() {
    synth.pause();
    showPaused();
  });

  stopBtn.addEventListener('click', function() {
    synth.cancel();
    clearSpeaking();
    showPaused();
    textQueue = [];
    queueIndex = 0;
    statusEl.textContent = 'Stopped';
  });

  // Click on content to read it
  document.addEventListener('click', function(e) {
    if (!isActive) return;

    // Get the actual element - handle SVG elements and text nodes
    var target = e.target;
    if (!target || !target.closest) return;

    // Ignore clicks on TTS controls
    if (target.closest('#tts-panel') || target.closest('#tts-toggle-btn')) return;

    // Find nearest readable block
    var block = target.closest('.tts-hoverable') || target.closest('[data-tts-block]');

    if (block) {
      e.preventDefault();
      e.stopPropagation();
      speakElement(block);
    }
  });

  // Escape to close
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isActive) hidePanel();
  });
})();
</script>
